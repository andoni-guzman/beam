# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


name: PostCommit Java Nexmark Runners 

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
  push:
    branches: ['master', 'release-*']
    tags: 'v*'
  pull_request:
    branches: ['master', 'release-*']
    tags: 'v*'
    paths: []

jobs:
  java-postcommit-nexmark-direct:
    variables:
      - name: bigQueryTable
        value: nexmark
      - name: bigQueryDataset
        value: nexmark
      - name: project
        value: apache-beam-testing
      - name: resourceNameMode
        value: QUERY_RUNNER_AND_MODE
      - name: exportSummaryToBigQuery
        value: true
      - name: tempLocation
        value: gs://temp-storage-for-perf-tests/nexmark
      - name: influxDatabase
        value: beam_test_metrics
      - name: influxHost
        value: http://10.128.0.96:8086 
      - name: baseInfluxMeasurement
        value: nexmark
      - name: exportSummaryToInfluxDB
        value: true
      - name: influxRetentionPolicy
        value: forever
        
    name: Run PostCommit Java Nexmark - runner
    runs-on: self-hosted
    strategy:
      fail-fast: true
    timeout-minutes: 240
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          submodules: recursive

      - name: Run *** RUN NEXMARK IN BATCH MODE USING DIRECT RUNNER ***
        uses: ./.github/actions/gradle-command-self-hosted-action
        with:
          gradle-command: >
            :sdks:java:testing:nexmark:run -Pnexmark.runner=:runners:direct-java 
            -Pnexmark.args=" 
              --runner=DirectRunner 
              --bigQueryTable=${{variables.bigQueryTable}}
              --bigQueryDataset=${{variables.bigQueryDataset}}
              --project=${{variables.project}} 
              --resourceNameMode=${{variables.resourceNameMode}}
              --exportSummaryToBigQuery=${{variables.exportSummaryToBigQuery}}
              --tempLocation=${{variables.tempLocation}}
              --influxDatabase=${{variables.influxDatabase}} 
              --influxHost=${{variables.influxHost}} 
              --baseInfluxMeasurement=${{variables.baseInfluxMeasurement}} 
              --exportSummaryToInfluxDB=${{variables.exportSummaryToInfluxDB}}
              --influxRetentionPolicy=${{variables.influxRetentionPolicy}}
              --streaming=false 
              --suite=SMOKE 
              --manageResources=false 
              --monitorJobs=true 
              --enforceEncodability=true 
              --enforceImmutability=true "
